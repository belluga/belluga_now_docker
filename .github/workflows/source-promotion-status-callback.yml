name: Source Promotion Status Callback

on:
  repository_dispatch:
    types:
      - lane-promotion-source-pr-status

permissions:
  actions: write
  contents: read
  pull-requests: read

concurrency:
  group: source-promotion-status-${{ github.event.client_payload.head || 'unknown' }}-${{ github.event.client_payload.base || 'unknown' }}
  cancel-in-progress: true

jobs:
  rerun_orchestration_checks:
    name: Rerun Orchestration PR Checks
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      CALLBACK_SOURCE_REPO: ${{ github.event.client_payload.source_repo }}
      CALLBACK_HEAD_BRANCH: ${{ github.event.client_payload.head }}
      CALLBACK_BASE_BRANCH: ${{ github.event.client_payload.base }}
      CALLBACK_SOURCE_PR_NUMBER: ${{ github.event.client_payload.source_pr_number }}
      CALLBACK_SOURCE_PR_URL: ${{ github.event.client_payload.source_pr_url }}
      CALLBACK_RESULT: ${{ github.event.client_payload.result }}
    steps:
      - name: Checkout orchestrator repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve submodule checkout auth
        id: submodule_auth
        env:
          SUBMODULES_REPO_TOKEN: ${{ secrets.SUBMODULES_REPO_TOKEN }}
          WEB_APP_REPO_TOKEN: ${{ secrets.WEB_APP_REPO_TOKEN }}
        run: |
          set -euo pipefail
          token="${SUBMODULES_REPO_TOKEN:-}"
          if [[ -z "$token" ]]; then
            token="${WEB_APP_REPO_TOKEN:-}"
          fi

          if [[ -z "$token" ]]; then
            echo "ERROR: missing required secret for private submodule checkout." >&2
            echo "Set SUBMODULES_REPO_TOKEN (recommended) or WEB_APP_REPO_TOKEN in this repository secrets." >&2
            exit 1
          fi

          echo "::add-mask::$token"
          echo "token=$token" >> "$GITHUB_OUTPUT"

      - name: Checkout submodules
        env:
          SUBMODULE_TOKEN: ${{ steps.submodule_auth.outputs.token }}
        run: |
          set -euo pipefail
          git config --global url."https://x-access-token:${SUBMODULE_TOKEN}@github.com/".insteadOf "https://github.com/"
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Validate callback payload and rerun checks
        run: bash .github/scripts/handle_source_promotion_status_callback.sh
